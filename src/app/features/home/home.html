<!-- Hero Section -->
<section class="section hero">
    <app-animation></app-animation>
    <div class="container">
        <div class="flex flex-col lg:flex-row items-center gap-12">
            <!-- Hero Content -->
            <div class="flex-1 fade-in-up">
                <h1 class="mb-6">
                    ÅVC Kollen
                </h1>
                <p class="text-xl text-[var(--text-1)] mb-8 max-w-[60ch]">
                    Hitta din närmaste återvinningscentral och lär dig sortera rätt.
                    Enkelt, snabbt och miljövänligt.
                </p>

                <!-- Search Component -->
                <div class="mb-6">
                    <input type="text" class="search-input" [ngModel]="searchQuery()"
                        (ngModelChange)="searchQuery.set($event)" (keyup.enter)="onSearch()" [disabled]="isLoading()"
                        placeholder="  Sök på postnummer, ort eller kommun..." aria-label="Sök återvinningscentral" />
                </div>

                <div class="flex gap-4 flex-wrap mb-4">
                    <p-button label="{{ isLoading() ? 'Söker...' : 'Sök nu' }}" (onClick)="onSearch()"
                        [disabled]="isLoading()" [loading]="isLoading()" severity="primary">
                        <i class="pi pi-search"></i>
                    </p-button>
                    <p-button label="Använd min plats" (onClick)="useMyLocation()" [disabled]="isLoading()"
                        severity="secondary">
                        <i class="pi pi-map-marker"></i>
                    </p-button>
                    @if (searchResults().length > 0 || nearestStation()) {
                    <p-button label="Rensa sökning" (onClick)="clearSearch()" severity="secondary">
                        <i class="pi pi-trash"></i>
                    </p-button>
                    }
                </div>

                <!-- Search Result / Error -->
                @if (errorMessage()) {
                <div class="p-4 bg-red-100 text-red-700 rounded-lg mb-4 fade-in">
                    <i class="pi pi-exclamation-circle mr-2"></i>
                    {{ errorMessage() }}
                </div>
                }

                @if (showSearchResults() && searchResults().length > 0) {
                <div class="mb-6 fade-in">
                    <h3 class="font-semibold text-lg mb-3">Stationer inom 1 mil</h3>
                    <div class="space-y-3">
                        @for (station of searchResults(); track station.id) {
                        <div class="card p-4 border-l-4 border-[var(--accent-0)] fade-in cursor-pointer hover:bg-[var(--bg-2)] transition-colors relative group"
                            (click)="openStationDialog(station)">
                            <button (click)="toggleFavorite(station, $event)"
                                class="absolute top-3 right-3 text-2xl transition-colors duration-200 hover:scale-110"
                                [class.text-yellow-400]="isFavorite(station.id)"
                                [style]="!isFavorite(station.id) ? 'color: var(--text-2)' : ''"
                                [attr.aria-label]="isFavorite(station.id) ? 'Ta bort från favoriter' : 'Lägg till i favoriter'">
                                <i [class.pi-star-fill]="isFavorite(station.id)"
                                    [class.pi-star]="!isFavorite(station.id)" class="pi"></i>
                            </button>
                            <div class="flex justify-between items-start pr-12">
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold">{{ station.name }}</h3>
                                    <p class="text-sm text-[var(--text-1)]">{{ station.address }}, {{ station.city }}
                                    </p>
                                </div>
                                <span
                                    class="badge bg-[var(--accent-soft)] text-[var(--accent-1)] px-2 py-1 rounded text-xs font-semibold">
                                    {{ station.distance | number:'1.1-1' }} km
                                </span>
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }

                @if (nearestStation() && !showSearchResults()) {
                <div class="card p-4 mb-4 border-l-4 border-[var(--accent-0)] fade-in cursor-pointer hover:bg-[var(--bg-2)] relative"
                    (click)="openStationDialog(nearestStation()!)">
                    <button (click)="toggleFavorite(nearestStation()!, $event)"
                        class="absolute top-3 right-3 text-2xl transition-colors duration-200 hover:scale-110"
                        [class.text-yellow-400]="isFavorite(nearestStation()!.id)"
                        [style]="!isFavorite(nearestStation()!.id) ? 'color: var(--text-2)' : ''"
                        [attr.aria-label]="isFavorite(nearestStation()!.id) ? 'Ta bort från favoriter' : 'Lägg till i favoriter'">
                        <i [class.pi-star-fill]="isFavorite(nearestStation()!.id)"
                            [class.pi-star]="!isFavorite(nearestStation()!.id)" class="pi"></i>
                    </button>
                    <div class="pr-12">
                        <h3 class="text-lg font-bold">{{ nearestStation()!.name }}</h3>
                        <p class="text-sm text-[var(--text-1)]">{{ nearestStation()!.address }}, {{
                            nearestStation()!.city }}</p>
                        <div class="flex items-center gap-2 mt-2">
                            <span
                                class="badge bg-[var(--accent-soft)] text-[var(--accent-1)] px-2 py-1 rounded text-xs font-semibold">
                                {{ nearestStation()!.distance | number:'1.1-1' }} km bort
                            </span>
                            <span class="text-xs text-[var(--text-2)]">Klicka för detaljer</span>
                        </div>
                    </div>
                </div>
                }
            </div>

            <!-- Hero Image -->
            <div class="flex-1 fade-in delay-200 flex justify-center">
                <img src="/assets/images/logotype/logo-bugrandy.svg" alt="ÅVC Kollen Logotyp"
                    class="w-full max-w-[400px] h-auto drop-shadow-xl" />
            </div>
        </div>
    </div>
</section>

<!-- Feature Cards Section -->
<section id="features" class="section">
    <div class="container">
        <h2 class="section-title text-center fade-in-up">
            Allt du behöver för återvinning
        </h2>
        <p class="section-description fade-in-up delay-100">
            ÅVC Kollen hjälper dig att hitta rätt plats och sortera rätt.
            Spara tid och gör skillnad för miljön.
        </p>

        <div class="feature-grid">
            <!-- Feature 1: Hitta ÅVC -->
            <div class="card fade-in-up delay-100">
                <div class="feature-icon">
                    <i class="pi pi-map-marker text-3xl" style="color: var(--accent-0);"></i>
                </div>
                <h3 class="text-2xl font-semibold mb-3">Hitta ÅVC</h3>
                <p class="text-[var(--text-1)] leading-relaxed">
                    Sök och hitta återvinningscentraler nära dig.
                    Få vägbeskrivning, öppettider och information om vad du kan lämna.
                </p>
            </div>

            <!-- Feature 2: Så sorterar du -->
            <div class="card fade-in-up delay-200">
                <div class="feature-icon">
                    <i class="pi pi-refresh text-3xl" style="color: var(--accent-0);"></i>
                </div>
                <h3 class="text-2xl font-semibold mb-3">Så sorterar du</h3>
                <p class="text-[var(--text-1)] leading-relaxed">
                    Lär dig hur du sorterar olika typer av avfall korrekt.
                    Guider för plast, papper, elektronik och mycket mer.
                </p>
            </div>

            <!-- Feature 3: Mina ÅVC -->
            <div class="card fade-in-up delay-300">
                <div class="feature-icon">
                    <i class="pi pi-heart text-3xl" style="color: var(--accent-0);"></i>
                </div>
                <h3 class="text-2xl font-semibold mb-3">Mina ÅVC</h3>
                <p class="text-[var(--text-1)] leading-relaxed">
                    Stjärnmärk dina favoritcentraler för snabb åtkomst.
                    Få notiser om ändringar i öppettider eller tjänster.
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Sorting Guide Section -->
<section id="sortera" class="section" style="background: color-mix(in srgb, var(--bg-1) 30%, transparent 70%);">
    <div class="container">
        <h2 class="section-title text-center">
            Så sorterar du rätt
        </h2>
        <p class="section-description">
            Olika material sorteras på olika sätt. Här är en snabbguide för de vanligaste avfallstyperna.
        </p>

        <!-- Waste Search -->
        <div class="max-w-xl mx-auto mb-10 relative">
            <h3 class="text-center text-sm font-semibold mb-2 uppercase tracking-wider text-[var(--accent-0)]">Osäker på
                vad du ska slänga?</h3>
            <div class="relative flex items-center">
                <i class="pi pi-search absolute left-4 text-[var(--text-2)]"></i>
                <input type="text" [ngModel]="wasteQuery()" (ngModelChange)="wasteQuery.set($event)"
                    (keyup.enter)="onWasteSearch()" placeholder="Sök på t.ex. 'mjölkpaket' eller 'batteri'"
                    class="search-input pl-12 pr-20 flex-1">
                <p-button label="Sök" (onClick)="onWasteSearch()" class="absolute right-1 text-sm"
                    severity="primary"></p-button>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-4xl mx-auto">
            <!-- Waste Type Icons -->
            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('tidningar-och-papper')">
                <div class="mb-4">
                    <i class="pi pi-file text-4xl" style="color: var(--blush-300);"></i>
                </div>
                <h4 class="font-semibold mb-2">Papper</h4>
                <p class="text-sm text-[var(--text-2)]">Tidningar, kartonger</p>
            </div>

            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('plastforpackningar')">
                <div class="mb-4">
                    <i class="pi pi-box text-4xl" style="color: var(--blush-300);"></i>
                </div>
                <h4 class="font-semibold mb-2">Plast</h4>
                <p class="text-sm text-[var(--text-2)]">Flaskor, förpackningar</p>
            </div>

            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('glasforpackningar')">
                <div class="mb-4">
                    <i class="pi pi-circle text-4xl" style="color: var(--blush-300);"></i>
                </div>
                <h4 class="font-semibold mb-2">Glas</h4>
                <p class="text-sm text-[var(--text-2)]">Burkar, flaskor</p>
            </div>

            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('elektronik')">
                <div class="mb-4">
                    <i class="pi pi-mobile text-4xl" style="color: var(--blush-300);"></i>
                </div>
                <h4 class="font-semibold mb-2">Elektronik</h4>
                <p class="text-sm text-[var(--text-2)]">Telefoner, datorer</p>
            </div>

            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('batterier')">
                <div class="mb-4">
                    <i class="pi pi-bolt text-4xl" style="color: var(--blush-300);"></i>
                </div>
                <h4 class="font-semibold mb-2">Batterier</h4>
                <p class="text-sm text-[var(--text-2)]">Alla typer</p>
            </div>

            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('metallforpackningar')">
                <div class="mb-4">
                    <i class="pi pi-trash text-4xl" style="color: var(--blush-300);"></i>
                </div>
                <h4 class="font-semibold mb-2">Metall</h4>
                <p class="text-sm text-[var(--text-2)]">Burkar, aluminium</p>
            </div>

            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('matavfall')">
                <div class="mb-4">
                    <i class="pi pi-sun text-4xl" style="color: var(--blush-300);"></i>
                </div>
                <h4 class="font-semibold mb-2">Organiskt</h4>
                <p class="text-sm text-[var(--text-2)]">Matavfall, trädgård</p>
            </div>

            <div class="card text-center p-6 cursor-pointer hover:transform hover:-translate-y-1 transition-all duration-300 hover:border-[var(--accent-soft)]"
                (click)="openSortingModal('farligt-avfall')">
                <div class="mb-4">
                    <i class="pi pi-exclamation-triangle text-4xl" style="color: var(--red-500);"></i>
                </div>
                <h4 class="font-semibold mb-2">Farligt</h4>
                <p class="text-sm text-[var(--text-2)]">Kemikalier, färg</p>
            </div>
        </div>

        <div class="text-center mt-8">
            <p-button routerLink="/sorteringsguide" label="Läs fullständig sorteringsguide" severity="primary">
                <i class="pi pi-book"></i>
            </p-button>
        </div>
    </div>
</section>

<!-- Station Detail Dialog - Using reusable component -->
<app-station-detail [station]="selectedStation()" [visible]="showStationDetail()" (onHide)="closeStationDialog()">
</app-station-detail>

<!-- Article Detail Dialog -->
<p-dialog [visible]="selectedArticle() !== null" [modal]="true" [maximizable]="false" [resizable]="false"
    (onHide)="closeModal()" [style]="{ 'max-width': '800px', 'width': '100%' }" class="p-dialog-custom">
    <ng-template pTemplate="header">
        @if (selectedArticle(); as article) {
        <div class="flex items-center gap-3">
            @if (article.color?.primary) {
            <div class="w-10 h-10 rounded-full flex items-center justify-center"
                [style.background-color]="article.color?.primary">
                <i class="pi pi-recycle text-white"></i>
            </div>
            }
            <div>
                <h2 class="text-xl font-bold">{{ article.title }}</h2>
                @if (article.category) {
                <p class="text-[var(--text-1)] text-xs">{{ article.category }}</p>
                }
            </div>
        </div>
        }
    </ng-template>

    <ng-template pTemplate="content">
        @if (selectedArticle(); as article) {
        <!-- Hero Image -->
        @if (article.image_url) {
        <div class="relative h-48 -mx-6 -mt-6 mb-6 overflow-hidden rounded-t-lg">
            <img [src]="'https://sopinfo.se/' + article.image_url" [alt]="article.title"
                class="w-full h-full object-cover">
        </div>
        }

        <!-- Excerpt -->
        @if (article.excerpt) {
        <p class="text-lg text-[var(--text-0)] mb-6 leading-relaxed">{{ article.excerpt }}</p>
        }

        <div class="space-y-6">
            <!-- Allowed Items -->
            @if (article.allowed && article.allowed.length > 0) {
            <div class="bg-green-500/10 border border-green-500/20 rounded-xl p-5">
                <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-green-400">
                    <i class="pi pi-check-circle"></i>
                    Får sorteras här
                </h3>
                <ul class="space-y-2">
                    @for (item of article.allowed; track item) {
                    <li class="flex items-start gap-2 text-[var(--text-0)]">
                        <i class="pi pi-check text-green-400 mt-1 flex-shrink-0"></i>
                        <span>{{ item }}</span>
                    </li>
                    }
                </ul>
            </div>
            }

            <!-- Not Allowed Items -->
            @if (article.not_allowed && article.not_allowed.length > 0) {
            <div class="bg-red-500/10 border border-red-500/20 rounded-xl p-5">
                <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-red-400">
                    <i class="pi pi-times-circle"></i>
                    Får INTE sorteras här
                </h3>
                <ul class="space-y-2">
                    @for (item of article.not_allowed; track item) {
                    <li class="flex items-start gap-2 text-[var(--text-0)]">
                        <i class="pi pi-times text-red-400 mt-1 flex-shrink-0"></i>
                        <span>{{ item }}</span>
                    </li>
                    }
                </ul>
            </div>
            }

            <!-- Tips -->
            @if (article.tips && article.tips.length > 0) {
            <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-5">
                <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-blue-400">
                    <i class="pi pi-lightbulb"></i>
                    Praktiska tips
                </h3>
                <ul class="space-y-2">
                    @for (tip of article.tips; track tip) {
                    <li class="flex items-start gap-2 text-[var(--text-0)]">
                        <i class="pi pi-arrow-right text-blue-400 mt-1 flex-shrink-0"></i>
                        <span>{{ tip }}</span>
                    </li>
                    }
                </ul>
            </div>
            }

            <!-- Why Text / Environmental Impact -->
            @if (article.why_text) {
            <div class="bg-[var(--accent-soft)] border border-[var(--accent-0)]/20 rounded-xl p-5">
                <h3 class="font-semibold text-lg mb-3 flex items-center gap-2 text-[var(--accent-0)]">
                    <i class="pi pi-globe"></i>
                    Därför är det viktigt
                </h3>
                <p class="text-[var(--text-0)] leading-relaxed">{{ article.why_text }}</p>
            </div>
            }
        </div>
        }
    </ng-template>

    <ng-template pTemplate="footer">
        @if (selectedArticle()) {
        <p-button label="Stäng" (onClick)="closeModal()" severity="secondary"></p-button>
        <p-button routerLink="/stationer" label="Hitta station" severity="primary">
            <i class="pi pi-map-marker"></i>
        </p-button>
        }
    </ng-template>
</p-dialog>

<section id="mina" class="section">
    <div class="container">
        <h2 class="section-title text-center">
            Mina ÅVC
        </h2>
        @if (!authService.isAuthenticated()) {
        <p class="section-description">
            Spara dina favoritcentraler för snabb åtkomst. Logga in eller skapa konto för att börja.
        </p>
        }

        <div class="max-w-2xl mx-auto">
            <!-- LOGGED IN USER VIEW -->
            @if (authService.isAuthenticated()) {
            @if (favoriteStations().length > 0) {
            <!-- Favorites List -->
            <div class="grid gap-3 fade-in">
                @for (station of favoriteStations(); track station.id) {
                <div class="card p-4 border-l-4 border-[var(--accent-0)] cursor-pointer hover:bg-[var(--bg-2)] transition-all flex justify-between items-center group relative"
                    (click)="openStationDialog(station)">

                    <!-- Favorite Toggle Button -->
                    <button (click)="toggleFavorite(station, $event)"
                        class="absolute top-3 right-3 text-2xl text-yellow-400 hover:scale-110 transition-transform z-10"
                        aria-label="Ta bort favoriter">
                        <i class="pi pi-star-fill"></i>
                    </button>

                    <div class="pr-10">
                        <h3 class="font-bold text-lg mb-1">{{ station.name }}</h3>
                        <div class="flex items-center gap-2 text-sm text-[var(--text-1)]">
                            <i class="pi pi-map-marker text-[var(--accent-1)]"></i>
                            <span>{{ station.address }}, {{ station.city }}</span>
                        </div>
                        @if (station.opening_info) {
                        <div class="mt-2 text-xs text-[var(--text-2)] bg-[var(--bg-1)] inline-block px-2 py-1 rounded">
                            <i class="pi pi-clock mr-1"></i>
                            {{ station.opening_info | slice:0:30 }}...
                        </div>
                        }
                    </div>

                    <div class="hidden sm:block">
                        <i
                            class="pi pi-chevron-right text-[var(--text-2)] group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
                }
            </div>
            } @else {
            <!-- Logged in but no favorites -->
            <div class="card text-center p-12 fade-in">
                <div class="mb-6">
                    <i class="pi pi-heart text-6xl" style="color: var(--text-2); opacity: 0.5;"></i>
                </div>
                <h3 class="text-2xl font-semibold mb-2">Inga favoriter än</h3>
                <p class="text-[var(--text-1)]">
                    Stjärnmärk stationer du besöker ofta för att samla dem här.
                </p>
            </div>
            }
            } @else {
            <!-- GUEST VIEW -->
            <div class="card text-center p-12 fade-in">
                <div class="mb-6">
                    <i class="pi pi-heart text-6xl" style="color: var(--accent-0);"></i>
                </div>
                <h3 class="text-2xl font-semibold mb-4">Inga favoriter än</h3>
                <p class="text-[var(--text-1)] mb-6">
                    Börja stjärnmärka återvinningscentraler för att se dem här.
                    Du kan enkelt hitta och besöka dina favoritplatser.
                </p>
                <div class="flex gap-4 justify-center flex-wrap">
                    <p-button label="Logga in" severity="primary" [routerLink]="['/login']">
                        <i class="pi pi-user"></i>
                    </p-button>
                    <p-button label="Skapa konto" severity="secondary" [routerLink]="['/register']">
                        <i class="pi pi-user-plus"></i>
                    </p-button>
                </div>
            </div>
            }
        </div>
    </div>
</section>

<!-- Stats/Info Section -->
<section class="section" style="background: color-mix(in srgb, var(--bg-1) 30%, transparent 70%);">
    <div class="container">
        <div class="grid md:grid-cols-3 gap-8 text-center">
            <div class="fade-in-up">
                <div class="text-5xl font-bold mb-2" style="color: var(--accent-0);">500+</div>
                <p class="text-[var(--text-1)]">Återvinningscentraler</p>
            </div>
            <div class="fade-in-up delay-100">
                <div class="text-5xl font-bold mb-2" style="color: var(--accent-0);">290</div>
                <p class="text-[var(--text-1)]">Kommuner i Sverige</p>
            </div>
            <div class="fade-in-up delay-200">
                <div class="text-5xl font-bold mb-2" style="color: var(--accent-0);">100%</div>
                <p class="text-[var(--text-1)]">Gratis att använda</p>
            </div>
        </div>
    </div>
</section>